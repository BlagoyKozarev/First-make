# FirstMake Agent - Ръководство за потребителя

Пълно ръководство за работа с FirstMake Agent за обработка и оптимизация на КСС.

## 📖 Съдържание

- [Въведение](#въведение)
- [Стартиране на приложението](#стартиране-на-приложението)
- [Работен процес](#работен-процес)
  - [Стъпка 1: Качване на файл](#стъпка-1-качване-на-файл)
  - [Стъпка 2: Преглед и извличане](#стъпка-2-преглед-и-извличане)
  - [Стъпка 3: Съпоставяне](#стъпка-3-съпоставяне)
  - [Стъпка 4: Оптимизация](#стъпка-4-оптимизация)
  - [Стъпка 5: Експорт](#стъпка-5-експорт)
- [Метрики и статистика](#метрики-и-статистика)
- [Чести проблеми](#чести-проблеми)
- [Съвети за оптимална работа](#съвети-за-оптимална-работа)

## 🎯 Въведение

FirstMake Agent е локално приложение за автоматизирано обработване на Количествено-стойностни сметки (КСС) и оптимизация на строителни оферти.

### Какво прави приложението?

1. **Парсира** документи (XLSX, DOCX, PDF) с КСС данни
2. **Извлича** структурирана информация чрез AI
3. **Съпоставя** позиции с вашата ценова база (fuzzy matching)
4. **Оптимизира** коефициенти чрез Linear Programming
5. **Генерира** Excel файлове с оптимизираната КСС

### Предимства

- ✅ **Локално** - Всички данни остават на вашия компютър
- ✅ **Бързо** - Обработва стотици позиции за секунди
- ✅ **Точно** - Математическа оптимизация вместо ръчно въвеждане
- ✅ **Гъвкаво** - Поддръжка на различни формати и структури

## 🚀 Стартиране на приложението

### Prerequisite

Уверете се, че имате инсталирани:
- .NET 8 Runtime
- Node.js 20+

### Стартиране (Development)

```bash
# Terminal 1 - API
cd src/Api
dotnet run --urls "http://localhost:5000"

# Terminal 2 - AI Gateway
cd src/AiGateway
dotnet run --urls "http://localhost:5001"

# Terminal 3 - UI
cd src/UI
npm run dev
```

Приложението ще бъде достъпно на: **http://localhost:5174**

### Стартиране (Docker)

```bash
docker-compose up -d
```

Приложението ще бъде достъпно на: **http://localhost:5174**

## 📋 Работен процес

### Стъпка 1: Качване на файл

**Страница:** Upload

#### Какво да направите:

1. Отворете приложението в браузър
2. Кликнете върху зоната за качване или влачете файл
3. Изберете файл с КСС данни (XLSX, DOCX, или PDF)
4. (Опционално) Включете OCR за сканирани документи
5. Кликнете **"Парсирай"**

#### Поддържани формати:

- **Excel (.xlsx)** - Препоръчва се! Най-надеждно извличане
- **Word (.docx)** - Добра поддръжка за таблици
- **PDF (.pdf)** - Работи с текстови PDF; за сканирани използвайте OCR

#### Какво се случва:

- Файлът се изпраща към AI Gateway
- За XLSX/DOCX: Директно парсиране на структурата
- За PDF: iText7 извлича текст; ако е празен → Tesseract OCR
- Резултатът се показва като preview на съдържанието

#### Пример екран:

```
┌─────────────────────────────────────────────┐
│  📁 Качете файл с КСС                       │
│  ┌─────────────────────────────────────┐   │
│  │  Влачете файл тук или кликнете     │   │
│  │  за избор (.xlsx, .docx, .pdf)     │   │
│  │                                     │   │
│  │  Max размер: 50MB                   │   │
│  └─────────────────────────────────────┘   │
│                                             │
│  ☐ Използвай OCR (за сканирани PDF)       │
│                                             │
│  [ Парсирай ]                               │
└─────────────────────────────────────────────┘
```

---

### Стъпка 2: Преглед и извличане

**Страница:** Review

#### Какво да направите:

1. Прегледайте parsнатото съдържание
2. Кликнете **"Извлечи BoQ"**
3. Изчакайте AI да извлече структурирани данни
4. Прегледайте извлечената КСС:
   - Проект информация
   - Етапи
   - Позиции с количества и мерни единици
5. (Опционално) Редактирайте грешни данни
6. Качете **ценова база** (JSON или XLSX)
7. Кликнете **"Съпоставяне"**

#### Формат на ценовата база:

**JSON формат:**
```json
[
  {
    "id": "cat-001",
    "name": "Бетон C25/30 доставен",
    "unit": "м3",
    "basePrice": 120.50,
    "category": "Бетонови работи"
  }
]
```

**Excel формат:**
| ID | Name | Unit | Base Price | Category |
|----|------|------|------------|----------|
| cat-001 | Бетон C25/30 доставен | м3 | 120.50 | Бетонови работи |

#### Какво се случва:

- API извиква AI Gateway с LLM extraction request
- BG GPT анализира parsнатите данни
- Връща структуриран JSON съгласно `boq.schema.json`
- UI визуализира извлечените данни в таблица

#### Пример екран:

```
┌─────────────────────────────────────────────────────────────┐
│  📊 Извлечена КСС                                          │
│  ──────────────────────────────────────────────────────── │
│  Проект: Жилищна сграда - София                           │
│  Изпълнител: ABC Строителство ООД                         │
│  Локация: гр. София, ж.к. Младост                         │
│  ──────────────────────────────────────────────────────── │
│  Етап 1: Бетонови работи                                  │
│  ┌────┬──────────────────┬──────┬────────┬───────────┐   │
│  │ №  │ Наименование     │ Ед.  │ Кол-во │ Баз. цена │   │
│  ├────┼──────────────────┼──────┼────────┼───────────┤   │
│  │ 1  │ Бетон C25/30     │ м3   │ 150.5  │ -         │   │
│  │ 2  │ Арматура ф12     │ кг   │ 3200   │ -         │   │
│  └────┴──────────────────┴──────┴────────┴───────────┘   │
│                                                            │
│  📎 Качи ценова база: [Избери файл]                       │
│  [ Съпоставяне ]                                           │
└─────────────────────────────────────────────────────────────┘
```

---

### Стъпка 3: Съпоставяне

**Страница:** Optimize (Matching View)

#### Какво да направите:

1. Прегледайте автоматичните съпоставяния
2. За всяка позиция:
   - Вижте топ 5 кандидати от ценовата база
   - Прегледайте score на съвпадение (0-100)
   - Проверете дали мерните единици съвпадат
3. **Одобрете** най-добрия кандидат или изберете друг
4. Повторете за всички позиции
5. Кликнете **"Оптимизирай"**

#### Как работи matching:

- **Exact match**: Идентични имена и единици → Score 100
- **Fuzzy match**: Levenshtein distance (разлика в символи)
- **Unit normalization**: "м3" = "m3" = "куб.м"
- **Caching**: Вече съпоставени позиции се кешират за 30 дни

#### Score интерпретация:

| Score | Качество | Препоръка |
|-------|----------|-----------|
| 95-100 | Отлично | Автоматично одобрение |
| 80-94 | Добро | Прегледайте |
| 60-79 | Средно | Внимателна проверка |
| <60 | Ниско | Вероятно грешно |

#### Пример екран:

```
┌─────────────────────────────────────────────────────────────┐
│  🔗 Съпоставяне на позиции                                 │
│  ──────────────────────────────────────────────────────── │
│  Позиция 1/25: Бетон C25/30 (150.5 м3)                    │
│                                                            │
│  Топ кандидати:                                            │
│  ┌─────────────────────────────────────────────────────┐  │
│  │ ✓ Бетон C25/30 доставен                             │  │
│  │   Score: 95.5 | Unit: м3 ✓ | Цена: 120.50 лв       │  │
│  │   [Одобри]                                          │  │
│  ├─────────────────────────────────────────────────────┤  │
│  │   Бетон C30/37                                      │  │
│  │   Score: 78.2 | Unit: м3 ✓ | Цена: 135.00 лв       │  │
│  │   [Избери]                                          │  │
│  ├─────────────────────────────────────────────────────┤  │
│  │   Бетон C20/25                                      │  │
│  │   Score: 72.1 | Unit: м3 ✓ | Цена: 110.00 лв       │  │
│  │   [Избери]                                          │  │
│  └─────────────────────────────────────────────────────┘  │
│                                                            │
│  [ ← Назад ]  [ Следваща → ]  [Оптимизирай]               │
└─────────────────────────────────────────────────────────────┘
```

---

### Стъпка 4: Оптимизация

**Страница:** Optimize (LP View)

#### Какво да направите:

1. Задайте параметри за оптимизация:
   - **Lambda (λ)**: Тежест на penalty за отклонение от 1.0 (по-високо = по-близо до 1.0)
   - **Min коефициент**: Минимална стойност (обичайно 0.4)
   - **Max коефициент**: Максимална стойност (обичайно 2.0)
2. (Опционално) Задайте целеви бюджети по етапи
3. Кликнете **"Изчисли"**
4. Прегледайте резултата:
   - Feasible/Infeasible (има ли решение)
   - Коефициенти per позиция
   - Обобщения по етапи
5. Кликнете **"Експорт"**

#### Параметри:

**Lambda (λ):**
- **Нисък (100-500)**: Повече свобода, коефициенти може да варират
- **Среден (1000)**: Балансирано - препоръчва се
- **Висок (5000+)**: Максимално близо до 1.0, по-малко гъвкавост

**Coefficient Bounds:**
- **0.4 - 2.0**: Стандартни граници за строителни оферти
- **0.8 - 1.2**: По-стриктни граници за публични поръчки

#### Какво се случва:

- API извиква Core.Engine.LpOptimizer
- Google OR-Tools (GLOP) решава Linear Program:
  - **Minimize**: Σ |coeff[i] - 1| × λ
  - **Subject to**: minCoeff ≤ coeff[i] ≤ maxCoeff
  - **Optional**: Етапни budget constraints
- Връща оптимизирани коефициенти

#### Пример екран:

```
┌─────────────────────────────────────────────────────────────┐
│  ⚙️ Оптимизация                                            │
│  ──────────────────────────────────────────────────────── │
│  Параметри:                                                │
│  Lambda (λ): [1000.0]                                      │
│  Min коефициент: [0.4]                                     │
│  Max коефициент: [2.0]                                     │
│                                                            │
│  [ Изчисли ]                                               │
│  ──────────────────────────────────────────────────────── │
│  ✅ Feasible: ДА                                           │
│  Objective Value: 12,345.67                                │
│                                                            │
│  Обобщение по етапи:                                       │
│  ┌────────────────┬──────────┬────────────┬─────────┐     │
│  │ Етап           │ Базова   │ Оптимизир. │ Avg κ   │     │
│  ├────────────────┼──────────┼────────────┼─────────┤     │
│  │ Бетонови       │ 18,075   │ 19,500     │ 1.08    │     │
│  │ Арматурни      │ 5,200    │ 4,800      │ 0.92    │     │
│  └────────────────┴──────────┴────────────┴─────────┘     │
│                                                            │
│  [ Експорт ]                                               │
└─────────────────────────────────────────────────────────────┘
```

---

### Стъпка 5: Експорт

**Страница:** Export

#### Какво да направите:

1. Прегледайте финалния резултат
2. Изберете опции за експорт:
   - **Единичен файл**: Един XLSX с всички етапи
   - **По етапи**: ZIP с отделни XLSX per етап
3. Кликнете **"Изтегли Excel"**
4. Отворете файла в Excel/LibreOffice

#### Excel структура:

**Колони:**
| № | Наименование | Ед. | Количество | Базова цена | Коефициент | Цена | Стойност |
|---|--------------|-----|------------|-------------|------------|------|----------|
| 1 | Бетон C25/30 | м3 | 150.5 | 120.50 | 1.15 | 138.58 | 20,856.19 |

**Формули:**
- **Цена** = Базова цена × Коефициент
- **Стойност** = Количество × Цена
- **Сума**: Автоматично SUM() на края на етап

**Форматиране:**
- Заглавия: Bold, сиво background
- Числа: 2 decimal places
- Валута: БГ лева (лв)
- Borders: Всички клетки

#### Пример файл:

```
КСС - Жилищна сграда - София.xlsx
  │
  ├─ Sheet: Бетонови работи
  │    №  Наименование      Ед.  Количество  Базова  κ    Цена    Стойност
  │    1   Бетон C25/30     м3   150.5       120.50  1.15 138.58  20,856.19
  │    2   Арматура ф12     кг   3,200       2.35    0.95 2.23    7,136.00
  │    ...
  │    ОБЩО:                                                       27,992.19
  │
  └─ Sheet: Арматурни работи
       ...
```

#### Какво се случва:

- API извиква ExcelExportService (EPPlus)
- Генерира XLSX с форматиране и формули
- За ZIP: Създава отделни файлове per етап + общ файл
- Връща binary data → браузърът автоматично download

---

## 📊 Метрики и статистика

**Страница:** Metrics

### Какво можете да видите:

1. **Общи статистики:**
   - Брой операции (parse, extract, match, optimize, export)
   - Success rate (%)
   - Среден размер на файлове
   - Среден брой позиции
   - Средна продължителност

2. **По тип операция:**
   - Разпределение на операциите
   - Грешки и warning-и

3. **Последни операции:**
   - Timestamp
   - Файл
   - Резултат (✅/❌)
   - Продължителност

### Използване:

- Проследявайте ефективността
- Откриване на проблеми
- Анализ на patterns

### Пример екран:

```
┌─────────────────────────────────────────────────────────────┐
│  📈 Метрики                                                │
│  ──────────────────────────────────────────────────────── │
│  Общо операции: 150                                        │
│  Success rate: 94.67%                                      │
│  Среден размер: 2.0 MB                                     │
│  Среден брой позиции: 75                                   │
│                                                            │
│  По тип:                                                   │
│  Parse:    50  ███████████                                 │
│  Extract:  30  ███████                                     │
│  Match:    30  ███████                                     │
│  Optimize: 25  ██████                                      │
│  Export:   15  ████                                        │
│                                                            │
│  Топ грешки:                                               │
│  • File size exceeds limit (5)                             │
│  • LLM timeout (2)                                         │
└─────────────────────────────────────────────────────────────┘
```

---

## ❓ Чести проблеми

### Проблем 1: Файлът не се парсира

**Възможни причини:**
- Файлът е повреден
- Формат не се поддържа (напр. .xls вместо .xlsx)
- Файлът е защитен с парола

**Решение:**
- Уверете се, че файлът е валиден XLSX/DOCX/PDF
- Конвертирайте стари .xls към .xlsx
- Премахнете защитата на файла

### Проблем 2: OCR не работи

**Възможни причини:**
- Tesseract не е инсталиран
- Липсват езикови пакети

**Решение:**
```bash
# Ubuntu
sudo apt-get install tesseract-ocr tesseract-ocr-bul tesseract-ocr-eng

# Verify
tesseract --version
```

### Проблем 3: Extraction връща грешен резултат

**Възможни причини:**
- LLM не разпознава структурата
- Неясна структура на документа

**Решение:**
- Използвайте XLSX вместо PDF (по-надеждно)
- Прегледайте и редактирайте резултата ръчно
- Подобрете форматирането на входния файл

### Проблем 4: Matching score е нисък

**Възможни причини:**
- Различна терминология в ценовата база
- Липсващи позиции

**Решение:**
- Обогатете ценовата база с повече aliases
- Добавете липсващите позиции ръчно
- Използвайте един и същи стандарт за наименования

### Проблем 5: Optimization е Infeasible

**Възможни причини:**
- Твърде стриктни bounds (minCoeff, maxCoeff)
- Невъзможни budget constraints

**Решение:**
- Разширете bounds (напр. 0.3 - 2.5)
- Премахнете или релаксирайте budget constraints
- Проверете дали има грешки в базовите цени

### Проблем 6: Excel export файлът е празен

**Възможни причини:**
- Липсват данни в result
- Грешка в ExcelExportService

**Решение:**
- Прегледайте browser console за errors
- Уверете се, че optimization е Feasible
- Проверете API logs

---

## 💡 Съвети за оптимална работа

### 1. Подготовка на файлове

✅ **Препоръчва се:**
- Използвайте XLSX формат където е възможно
- Структурирани таблици с ясни заглавия
- Консистентни мерни единици
- Валидни числа (без текст в количества)

❌ **Избягвайте:**
- Сканирани PDF без OCR
- Merge-нати клетки в Excel
- Смесени данни (текст и числа в една колона)
- Празни редове между позициите

### 2. Ценова база

✅ **Best practices:**
- Използвайте каноничен формат (JSON или XLSX)
- Добавете aliases за често използвани вариации
- Групирайте по категории
- Актуализирайте редовно

**Пример aliases:**
```json
{
  "name": "Бетон C25/30",
  "aliases": [
    "бетон c25/30",
    "бетон клас 25/30",
    "concrete c25/30",
    "c25 concrete"
  ]
}
```

### 3. Matching workflow

- **Auto-approve** позиции с score >95
- **Прегледайте внимателно** score 80-95
- **Ръчна проверка** за score <80
- Използвайте кеша - не променяйте вече одобрени позиции без причина

### 4. Optimization параметри

**За стандартни оферти:**
- Lambda: 1000
- Min: 0.4
- Max: 2.0

**За публични поръчки:**
- Lambda: 5000
- Min: 0.8
- Max: 1.2

**За експериментални оферти:**
- Lambda: 500
- Min: 0.3
- Max: 3.0

### 5. Performance tips

- Работете с файлове <10MB където е възможно
- Batch process множество КСС едновременно
- Използвайте кеша за повтарящи се позиции
- Архивирайте стари сесии

### 6. Качество на данни

**Проверявайте:**
- Количества са положителни числа
- Мерни единици са консистентни
- Цени са в разумни граници
- Няма дублирани позиции

**Валидация checklist:**
```
☐ Име на проект е попълнено
☐ Всички етапи имат позиции
☐ Количества > 0
☐ Всички единици са валидни
☐ Няма празни редове
☐ Базови цени са разумни
```

---

## 🆘 Поддръжка

За въпроси и проблеми:

1. Прегледайте документацията в `/docs`
2. Проверете [GitHub Issues](https://github.com/BlagoyKozarev/First-make/issues)
3. Отворете нов Issue с детайли

**При отваряне на Issue включете:**
- Описание на проблема
- Стъпки за репродукция
- Очакван vs реален резултат
- Screenshots
- Environment (OS, browser, .NET version)

---

**Последна актуализация:** 2025-01-13

**Версия:** 1.0.0
